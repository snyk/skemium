version: 2.1
setup: true

orbs:
  prodsec: snyk/prodsec-orb@1
  snyk: snyk/snyk@2
  orb-tools: circleci/orb-tools@12.3
  shellcheck: circleci/shellcheck@3.2

# TODO: still unsure what this filter does exactly...
filters: &filters
  tags:
    only: /.*/

jobs:
  security-scans:
    resource_class: medium
    docker:
      - image: cimg/openjdk:23.0.2
    steps:
      - checkout
      - prodsec/security_scans:
          mode: auto
          open-source-additional-arguments: --exclude=test
          iac-scan: disabled

  orb-test:
    resource_class: medium
    docker:
      - image: cimg/openjdk:23.0.2
        environment:
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: postgres
      - image: cimg/postgres:14.16
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
    steps:
      - checkout
      - run:
          name: "Build Skemium Binary"
          command: |
            mvn package assembly:single -DskipTests
            ls ./target
            mv ./target/skemium-*-jar-with-dependencies.jar /tmp/skemium.jar
            echo '#!/bin/bash
            java -jar /tmp/skemium.jar "$@"' > /tmp/skemium
            chmod +x /tmp/skemium
      - run:
          name: "Orb Tests"
          command: orb/test/test.sh

workflows:
  version: 2
  CI (CircleCI):
    jobs:
      - prodsec/secrets-scan:
          name: Scan repository for secrets
          context:
            - snyk-bot-slack
          channel: alerts-data-products
          trusted-branch: main

      - security-scans:
          name: Security Scans
          context:
            - appsecex_data-backend
      - orb-tools/lint:
          filters: *filters
          source_dir: orb
      - orb-tools/pack:
          filters: *filters
          source_dir: orb
      - orb-tools/review:
          source_dir: orb
          filters: *filters
      - shellcheck/check:
          filters: *filters
      - orb-test:
          filters: *filters
      # Release dev versions.
      # TODO: uncomment
      # - orb-tools/publish:
      #     orb_name: skemium
      #     vcs_type: << pipeline.project.type >>
      #     pub_type: dev
      #     requires:
      #       - orb-tools/pack
      #     context: TODO
      #     filters: *filters
      # Triggers the next workflow in the Orb Development Kit.
      - orb-tools/continue:
          pipeline_number: << pipeline.number >>
          vcs_type: << pipeline.project.type >>
          orb_name: skemium
          config_path: .circleci/orb.yml
          requires:
            - orb-tools/lint
            - orb-tools/pack
            - orb-tools/review
            - shellcheck/check
            - orb-test
          filters: *filters
